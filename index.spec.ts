import bitcoin, { initEccLib } from "bitcoinjs-lib";
import { toXOnly } from "bitcoinjs-lib/src/psbt/bip371";
import { expect, test } from "bun:test";
import ECPairFactory from "ecpair";
import * as ecc from "tiny-secp256k1";
import {
  InscriptionRequest,
  buildOrdScript,
  getSignatureValidator,
  makeKeypairFromWIF,
  validateEcdsaSignature,
  validateSchnorrSignature,
} from ".";
initEccLib(ecc);
const ECPair = ECPairFactory(ecc);

const keypair = ECPair.makeRandom({ network: bitcoin.networks.testnet });

test("testSignatureValidator", () => {
  const p2trAddress = bitcoin.payments.p2tr({
    internalPubkey: toXOnly(keypair.publicKey),
    network: bitcoin.networks.testnet,
  });
  const p2wpkh = bitcoin.payments.p2wpkh({
    pubkey: keypair.publicKey,
    network: bitcoin.networks.testnet,
  });

  const validator = getSignatureValidator(p2trAddress.address!);

  expect(validator).toBe(validateSchnorrSignature);

  const validator2 = getSignatureValidator(p2wpkh.address!);
  expect(validator2).toBe(validateEcdsaSignature);
});

test("makeKeypairFromWif", () => {
  const wif = keypair.toWIF();

  const keypair0 = makeKeypairFromWIF(wif, bitcoin.networks.testnet);

  expect(keypair0.toWIF()).toBe(keypair.toWIF());
});

test("buildOrdScript", () => {
  const pubkey = Buffer.from(
    "3cc131de4d37f22d1a4a3e6c245b451ac6838b8c043253e95f54820ebe0efe81",
    "hex"
  );

  const request: InscriptionRequest = {
    contentType: "image/png",
    content: Buffer.from(
      "89504e470d0a1a0a0000000d494844520000002a0000002a08020000004aa15e0c0000050d4944415478daed985f485b571cc7bf5e34416c50afb2e1657f928bd46b27a560d832ab45d20e8930fa60d30a2913ea531ff6b4b9d231b6b287f641f63069d122422d0aba286b91296534048c236c0988c88c7fb857dc766535b959b875e2bf6c0fbf7a7697c46c1ac1971ee47aeeb9bf733edfdf9f73eed5bcadfa461c5fe370aced98f1f939ce3705fcac9f3d8fccd268969f233b086b9920eeddfaf653600af86b6b6b45519465d914f03333eea8d80082b01a8391ce06208aa2dbed66665c8eec982a03a06b9920a62b30b2655966d7a3c9bd5141992096096250fd5741303635599645510c87c3b9067fbe201953e5982a3bb03c5f90340a5a149c8b823308abdbeda67c1398518f60e3b56daf007060998dfcb0b6441d968b8fbc3f51be994d381cf67abd39e14d01bf268a7fb96f38b06c2cf5aa6d8e8153a618f34d73294187f47e716d2d1ef6b27ddcb6bd42f16719613120763c1ecf38f730a5b755df680af8a1ebe9bbbc6a9b33c67fbe20497e979696928294b987acfc7470dbf64a7fc11b4cc47c4192a4c4e37162cbb24cb38ee6d44b3f61a81801900eb61d887d64673e817dbe71ba9d7db274eabd572f5cb802e0345778962bfa6a776d26b9b157752f7e9fe60a73c51bc189c48f1cc701a869b227933a199ce58ada764e201f84274ba7b339086b3ff73c27bc29e0a7e5146592e7cd002c163b3dfaf9fbdfa933955c473ea692ebc6f0f87ce30e673376f0f5a1dff7c456944962afcf551617bfadeba114b399e446f74e7426b9e1f38dab418d8d3f7efc65c672e10ec406c0f3664ddbb4bc25eb7ac862b113a3a6a9b2eb4617b3a7bee0e08d8bf4f47c7698e0137b62e2a124d988cd22afeb21c1f122fe354d955de8627de30aba1edadaca07b60e8c3705fc8f1ef54c4c3c7c9dab0356894d57f21ec0bd2ffa46274729c2ac1a52f2128bfd79e08d47eca9293f80a293ab00d6172a707295bc2706f15a1a5a005cbcf8f9410fabbc8c9f4754237d7d372311854624c9461de63ded3a16802c54be84ef1debcd08ca803705fc7d7d370144228aaa2604a1385d01004ddb04505e5e9845015fc203d88f9da1f2891d892891885257275dbaf48eaa26e81145627da142d336356d331251dadbef64f1982fe1cd667316762a7eef509b96245b5d9df44b90e738eef2e577ebeb4f75760e91022a824844e9ec1c1a1cfc84edbd74a7cd66f3dd91bbd9bfbeb914bf3d1ed7e0e004c5f6cdba3f28bb168bdde71b2705d49e2f9702989e5e01a02534e62efd10fbbbf0b707fe2b47108a3b3a5a5954c9b9d9274b747676760e8d3f58187fb0609c52d354a906b5deb15eb3a1ede6ed2aca6ff7ef7f9cf1d33bf3c6a3ec4a928d4a2f1add004282c38ee03f5b999c333616fcddbc5d36d8ededeee8683d80f75bf58d14def5850a2685a88283d7f55034ba4151359bcd6cd6f2f2a4e0e053ced76e6f3700aad981db03590290e1d83951b57aedda1d00245f926c40281add204146175535012800acd68681db03573fbd9ab2d4d2d2af2e97338bf7a9fbde14f07774b45657db48018990241b953a8d5c775f4f897075b5cd6a6d50831a53e0f1b8a8922a2b5f2b8a9da1f16ca7de582c4a9d96b959b62800a6e3d62dcfb9731ea7b33965098fc72508c5a480d261b5369099c7e33a7ffeccd3a7d3eded1f3a9dcdfbe289fdcdda3300c3d167ecb1d1b9e1e17b15152559140070b93e1819e9b7db45a6c0d846ab6bde2f2bff0fef596b999bdd2f6757ca5f617da3dc749ef13685bdef2b673f418768e9c8fffbc2cd3ef3e5bf965ee2736a7f037e19b2c6075dae350000000049454e44ae426082",
      "hex"
    ),
    recipientAddress: "",
  };
  const buf: Buffer = buildOrdScript(pubkey, request);
  expect(buf.toString("hex")).toBe(
    "203cc131de4d37f22d1a4a3e6c245b451ac6838b8c043253e95f54820ebe0efe81ac0063036f7264010109696d6167652f706e67004d080289504e470d0a1a0a0000000d494844520000002a0000002a08020000004aa15e0c0000050d4944415478daed985f485b571cc7bf5e34416c50afb2e1657f928bd46b27a560d832ab45d20e8930fa60d30a2913ea531ff6b4b9d231b6b287f641f63069d122422d0aba286b91296534048c236c0988c88c7fb857dc766535b959b875e2bf6c0fbf7a7697c46c1ac1971ee47aeeb9bf733edfdf9f73eed5bcadfa461c5fe370aced98f1f939ce3705fcac9f3d8fccd268969f233b086b9920eeddfaf653600af86b6b6b45519465d914f03333eea8d80082b01a8391ce06208aa2dbed66665c8eec982a03a06b9920a62b30b2655966d7a3c9bd5141992096096250fd5741303635599645510c87c3b9067fbe201953e5982a3bb03c5f90340a5a149c8b823308abdbeda67c1398518f60e3b56daf007060998dfcb0b6441d968b8fbc3f51be994d381cf67abd39e14d01bf268a7fb96f38b06c2cf5aa6d8e8153a618f34d73294187f47e716d2d1ef6b27ddcb6bd42f16719613120763c1ecf38f730a5b755df680af8a1ebe9bbbc6a9b33c67fbe20497e979696928294b987acfc7470dbf64a7fc11b4cc47c4192a4c4e37162cbb24cb38ee6d44b3f61a81801900eb61d887d64673e817dbe71ba9d7db274eabd572f5cb802e0345778962bfa6a776d26b9b157752f7e9fe60a73c51bc189c48f1cc701a869b227933a199ce58ada764e201f84274d08024ba7b339086b3ff73c27bc29e0a7e5146592e7cd002c163b3dfaf9fbdfa933955c473ea692ebc6f0f87ce30e673376f0f5a1dff7c456944962afcf551617bfadeba114b399e446f74e7426b9e1f38dab418d8d3f7efc65c672e10ec406c0f3664ddbb4bc25eb7ac862b113a3a6a9b2eb4617b3a7bee0e08d8bf4f47c7698e0137b62e2a124d988cd22afeb21c1f122fe354d955de8627de30aba1edadaca07b60e8c3705fc8f1ef54c4c3c7c9dab0356894d57f21ec0bd2ffa46274729c2ac1a52f2128bfd79e08d47eca9293f80a293ab00d6172a707295bc2706f15a1a5a005cbcf8f9410fabbc8c9f4754237d7d372311854624c9461de63ded3a16802c54be84ef1debcd08ca803705fc7d7d370144228aaa2604a1385d01004ddb04505e5e9845015fc203d88f9da1f2891d892891885257275dbaf48eaa26e81145627da142d336356d331251dadbef64f1982fe1cd667316762a7eef509b96245b5d9df44b90e738eef2e577ebeb4f75760e91022a824844e9ec1c1a1cfc84edbd74a7cd66f3dd91bbd9bfbeb914bf3d1ed7e0e004c5f6cdba3f28bb168bdde71b2705d49e2f9702989e5e01a02534e62efd10fbbbf0b707fe2b47108a3b3a5a5954c9b9d9274b747676760e8d3f58187fb0609c52d354a906b5deb15eb3a1ede6ed2aca6ff7ef7f9cf1d33bf3c6a3ec4a928d4a2f1add004282c38ee03f5b999c333616fcddbc5d36d8ed4d3601edeee8683d80f75bf58d14def5850a2685a88283d7f55034ba4151359bcd6cd6f2f2a4e0e053ced76e6f3700aad981db03590290e1d83951b57aedda1d00245f926c40281add204146175535012800acd68681db03573fbd9ab2d4d2d2af2e97338bf7a9fbde14f07774b45657db48018990241b953a8d5c775f4f897075b5cd6a6d50831a53e0f1b8a8922a2b5f2b8a9da1f16ca7de582c4a9d96b959b62800a6e3d62dcfb9731ea7b33965098fc72508c5a480d261b5369099c7e33a7ffeccd3a7d3eded1f3a9dcdfbe289fdcdda3300c3d167ecb1d1b9e1e17b15152559140070b93e1819e9b7db45a6c0d846ab6bde2f2bff0fef596b999bdd2f6757ca5f617da3dc749ef13685bdef2b673f418768e9c8fffbc2cd3ef3e5bf965ee2736a7f037e19b2c6075dae350000000049454e44ae42608268"
  );
});
